<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon - Войти/Регистрация</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        connect-src 'self' https://zamhgvmayjcyvdkuauxe.supabase.co;
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
    ">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header-bar">
        <h1 class="app-header-title">войти в neon</h1>
        <a href="index.html" class="neon-logo">Ne</a>
    </div>

    <div class="login-center-container">
        <div class="panel login-form-panel">
            <h2 id="form-heading">Войти</h2>
           
            <form id="auth-form">
                <div class="form-group"><input type="email" id="auth-email" placeholder="email" required></div>
                <div class="form-group hidden" id="login-group"><input type="text" id="auth-login" placeholder="логин (имя пользователя)" required></div>
                <div class="form-group"><input type="password" id="auth-password" placeholder="пароль" required></div>
                <div class="form-group"><button type="submit" id="auth-button" class="neon-button">Войти</button></div>
            </form>

            <div id="check-email-view" class="hidden">
                <h2 class="orange-heading">Проверьте почту!</h2>
                <p style="color:#fff; font-size:0.9em; margin:15px 0 25px;">
                    На ваш email (<span id="pending-email" class="orange-text"></span>) отправлено письмо с проверочной ссылкой.
                </p>
            </div>

            <div id="success-view" class="hidden">
                <h2 class="orange-heading">Регистрация успешно завершена</h2>
                <p style="color:#fff; font-size:0.9em; margin:15px 0 25px; line-height:1.6;">
                    Спасибо за регистрацию в Neon! Также вы можете скачать
                    <a href="#" id="apps-link" class="app-link">наши приложения</a>
                    почти для любого устройства.
                p>
                <button type="button" id="go-to-notes" class="neon-button">Перейти в Neon</button>
            </div>
           
            <div class="register-section" id="toggle-section">
                <span id="toggle-text">Ещё нет аккаунта в Neon?</span>
                <a href="#" id="toggle-link" class="register-link">Зарегистрируйтесь!</a>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zamhgvmayjcyvdkuauxe.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWhndm1heWpjeXZka3VhdXhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzc4ODksImV4cCI6MjA3OTQ1Mzg4OX0.8wEp6oRH7XcZtc-4kZaIBNZWnLfmUEe23BNpaFoi7_o';

        const authForm = document.getElementById('auth-form');
        const checkEmailView = document.getElementById('check-email-view');
        const successView = document.getElementById('success-view');
        const authButton = document.getElementById('auth-button');
        const formHeading = document.getElementById('form-heading');
        const toggleLink = document.getElementById('toggle-link');
        const loginGroup = document.getElementById('login-group');
        const toggleSection = document.getElementById('toggle-section');

        let isLoginMode = true;

        async function sb(endpoint, options = {}) {
            return fetch(SUPABASE_URL + endpoint, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': ANON_KEY,
                    ...options.headers
                }
            });
        }

        function showAuthView(isLogin) {
            isLoginMode = isLogin;
            checkEmailView.classList.add('hidden');
            successView.classList.add('hidden');
            authForm.classList.remove('hidden');
            toggleSection.classList.remove('hidden');
            if (isLogin) {
                formHeading.textContent = 'Войти';
                authButton.textContent = 'Войти';
                toggleLink.textContent = 'Зарегистрируйтесь!';
                document.getElementById('toggle-text').textContent = 'Ещё нет аккаунта в Neon?';
                loginGroup.classList.add('hidden');
            } else {
                formHeading.textContent = 'Регистрация';
                authButton.textContent = 'Зарегистрироваться';
                toggleLink.textContent = 'Войти!';
                document.getElementById('toggle-text').textContent = 'Уже есть аккаунт?';
                loginGroup.classList.remove('hidden');
            }
        }

        function showCheckEmailView(email) {
            document.getElementById('pending-email').textContent = email;
            authForm.classList.add('hidden');
            successView.classList.add('hidden');
            checkEmailView.classList.remove('hidden');
            toggleSection.classList.add('hidden');
        }

        function showSuccessView() {
            authForm.classList.add('hidden');
            checkEmailView.classList.add('hidden');
            successView.classList.remove('hidden');
            toggleSection.classList.add('hidden');
        }

        function init() {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            const type = params.get('type');
           
            if (accessToken && type === 'signup') {
                localStorage.setItem('neon_token', accessToken);
                showSuccessView();
            } else {
                showAuthView(true);
            }
            document.getElementById('go-to-notes').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            document.getElementById('apps-link').addEventListener('click', (e) => {
                e.preventDefault();
                alert('Страница приложений будет добавлена позже!');
            });
        }

        toggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            showAuthView(!isLoginMode);
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            const login = document.getElementById('auth-login').value.trim();

            authButton.disabled = true;
            if (isLoginMode) {
                try {
                    const res = await sb('/auth/v1/token?grant_type=password', {
                        method: 'POST',
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (res.ok && data.access_token) {
                        localStorage.setItem('neon_token', data.access_token);
                        window.location.href = 'index.html';
                    } else {
                        alert('Ошибка входа: ' + (data.error_description || 'Неверный email или пароль'));
                    }
                } catch (err) {
                    alert('Ошибка сети');
                }
            } else {
                try {
                    const res = await sb('/auth/v1/signup', {
                        method: 'POST',
                        body: JSON.stringify({ email, password, data: { username: login } })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        showCheckEmailView(email);
                    } else {
                        alert('Ошибка регистрации: ' + (data.msg || data.error));
                    }
                } catch (err) {
                    alert('Ошибка сети');
                }
            }
            authButton.disabled = false;
        });

        init();
    </script>
</body>
</html>